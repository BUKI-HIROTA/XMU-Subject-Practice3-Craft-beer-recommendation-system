<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 啤酒推荐系统 - 个性化推荐版</title>
    
    <!-- 加载 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 配置 Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- 加载 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        body { background-color: #f8fafc; }
        .star-rating { direction: ltr; display: inline-flex; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        /* 切换开关样式 */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useRef, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Search, Beer, Star, BarChart3, Info, ThumbsUp, Activity, 
            Droplets, Eye, Wind, Upload, FileText, Calculator, ArrowUpDown, Filter, Dices, Factory, Loader2, Database, Download, User, Heart, X, Cpu, PieChart, Settings, Server, Play, CheckCircle 
        } from 'lucide-react';

        // --- IndexedDB 辅助函数 ---
        const DB_NAME = 'BeerAppDB';
        const STORE_NAME = 'beerDataStore';
        const DB_VERSION = 1;

        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        };

        const saveToDB = async (key, data) => {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(data, key);
                return new Promise((resolve, reject) => {
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            } catch (err) { console.error("IndexedDB 保存失败:", err); }
        };

        const loadFromDB = async (key) => {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(key);
                return new Promise((resolve) => {
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });
            } catch (err) { console.error("IndexedDB 读取失败:", err); return null; }
        };

        const clearDB = async () => {
            try {
                const db = await openDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.clear();
                return new Promise((resolve) => { tx.oncomplete = () => resolve(); });
            } catch (err) { console.error("IndexedDB 清除失败:", err); }
        };

        // --- Web Worker 代码 (包含 CSV 解析 + 机器学习训练引擎) ---
        const workerCode = `
            self.onmessage = function(e) {
                const { type } = e.data;

                // --- 1. 机器学习训练引擎 (简易梯度下降) ---
                if (type === 'train_model') {
                    const { data } = e.data; // data 是已聚合的啤酒数组
                    
                    if (!data || data.length === 0) {
                        self.postMessage({ type: 'train_error', error: "没有数据可供训练" });
                        return;
                    }

                    // 准备训练数据
                    const features = [];
                    const targets = [];
                    
                    for (let i = 0; i < data.length; i++) {
                        const b = data[i];
                        // 简单的归一化: 评分/5, ABV/20 (假设最大20度)
                        features.push([
                            1, // Bias term (截距)
                            (b.aroma || 0) / 5,
                            (b.appearance || 0) / 5,
                            (b.palate || 0) / 5,
                            (b.taste || 0) / 5,
                            (b.abv || 0) / 20
                        ]);
                        targets.push((b.overall || 0)); 
                    }

                    // 初始化权重 (Bias, Aroma, App, Palate, Taste, ABV)
                    let weights = [0.1, 0.2, 0.2, 0.2, 0.2, 0.1]; 
                    const learningRate = 0.05;
                    const epochs = 2000; 
                    const m = features.length;

                    // 梯度下降训练循环
                    for (let epoch = 0; epoch < epochs; epoch++) {
                        let gradients = [0, 0, 0, 0, 0, 0];
                        let errorSum = 0;

                        for (let i = 0; i < m; i++) {
                            let prediction = 0;
                            for (let j = 0; j < weights.length; j++) {
                                prediction += weights[j] * features[i][j];
                            }

                            const error = prediction - targets[i];
                            errorSum += error * error;

                            for (let j = 0; j < weights.length; j++) {
                                gradients[j] += (error * features[i][j]);
                            }
                        }

                        for (let j = 0; j < weights.length; j++) {
                            weights[j] -= (learningRate * gradients[j]) / m;
                        }

                        if (epoch % 100 === 0) {
                            const rmse = Math.sqrt(errorSum / m);
                            self.postMessage({ type: 'train_progress', epoch, epochs, rmse });
                        }
                    }

                    // 计算最终 RMSE
                    let finalErrorSum = 0;
                    const predictions = [];
                    for (let i = 0; i < m; i++) {
                        let prediction = 0;
                        for (let j = 0; j < weights.length; j++) {
                            prediction += weights[j] * features[i][j];
                        }
                        const error = prediction - targets[i];
                        finalErrorSum += error * error;
                        predictions.push({ score: prediction, label: targets[i] >= 4 ? 1 : 0 });
                    }
                    const finalRMSE = Math.sqrt(finalErrorSum / m);

                    // 计算实际 AUC
                    // 将预测结果按分数降序排列
                    predictions.sort((a, b) => b.score - a.score);
                    
                    let positiveCount = 0;
                    let negativeCount = 0;
                    predictions.forEach(p => {
                        if (p.label === 1) positiveCount++; else negativeCount++;
                    });

                    let auc = 0;
                    if (positiveCount > 0 && negativeCount > 0) {
                        let tp = 0; 
                        let fp = 0;
                        let prevFpr = 0;
                        let prevTpr = 0;
                        
                        for (let i = 0; i < predictions.length; i++) {
                            if (predictions[i].label === 1) {
                                tp++;
                            } else {
                                fp++;
                            }
                            const tpr = tp / positiveCount;
                            const fpr = fp / negativeCount;
                            
                            // 梯形法则计算面积
                            auc += (fpr - prevFpr) * (tpr + prevTpr) / 2;
                            prevFpr = fpr;
                            prevTpr = tpr;
                        }
                    }

                    const rawImportance = weights.slice(1).map(Math.abs);
                    const totalImp = rawImportance.reduce((a, b) => a + b, 0);
                    const featureImportance = {
                        aroma: (rawImportance[0] / totalImp) * 100,
                        appearance: (rawImportance[1] / totalImp) * 100,
                        palate: (rawImportance[2] / totalImp) * 100,
                        taste: (rawImportance[3] / totalImp) * 100,
                        abv: (rawImportance[4] / totalImp) * 100
                    };

                    self.postMessage({ 
                        type: 'train_done', 
                        weights: weights, 
                        metrics: { rmse: finalRMSE, auc: auc }, // 传递计算出的真实 AUC
                        featureImportance
                    });
                    return;
                }

                // --- 2. JSON 解析 ---
                if (type === 'json') {
                    const { fileContent } = e.data;
                    try {
                        const data = JSON.parse(fileContent);
                        let count = 0;
                        if (Array.isArray(data)) { count = data.length; } 
                        else if (data.beerData && Array.isArray(data.beerData)) { count = data.beerData.length; }
                        self.postMessage({ type: 'done', data: data, processedLines: count });
                    } catch (err) { self.postMessage({ error: "JSON 解析失败: " + err.message }); }
                    return;
                }

                // --- 3. CSV 解析 ---
                const { fileContent } = e.data;
                const lines = fileContent.split('\\n');
                if (lines.length < 2) { self.postMessage({ error: "CSV 文件内容为空" }); return; }
                const parseCSVLine = (line) => {
                    const result = []; let current = ''; let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') inQuotes = !inQuotes;
                        else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } 
                        else current += char;
                    }
                    result.push(current.trim());
                    return result.map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"'));
                };
                const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim());
                const idxMap = {
                    name: headers.indexOf('beer_name'), brewery: headers.indexOf('brewery_name'),
                    style: headers.indexOf('beer_style'), abv: headers.indexOf('beer_abv'),
                    aroma: headers.indexOf('review_aroma'), appearance: headers.indexOf('review_appearance'),
                    palate: headers.indexOf('review_palate'), taste: headers.indexOf('review_taste'),
                    overall: headers.indexOf('review_overall')
                };
                if (idxMap.name === -1) { self.postMessage({ error: "未找到 'beer_name' 列" }); return; }
                const aggregationMap = new Map();
                let processedCount = 0;
                const colors = ["bg-gray-900", "bg-amber-600", "bg-yellow-400", "bg-orange-500", "bg-yellow-200", "bg-amber-500", "bg-red-900", "bg-green-600", "bg-amber-700"];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i]; if (!line.trim()) continue;
                    let cols; if (line.indexOf('"') === -1) { cols = line.split(','); } else { cols = parseCSVLine(line); }
                    const name = cols[idxMap.name]; if (!name) continue;
                    processedCount++;
                    const aroma = parseFloat(cols[idxMap.aroma]) || 0;
                    const appearance = parseFloat(cols[idxMap.appearance]) || 0;
                    const palate = parseFloat(cols[idxMap.palate]) || 0;
                    const taste = parseFloat(cols[idxMap.taste]) || 0;
                    const overall = parseFloat(cols[idxMap.overall]) || 0;
                    const abv = parseFloat(cols[idxMap.abv]) || 0;
                    let entry = aggregationMap.get(name);
                    if (!entry) {
                        entry = {
                            name: name, brewery: idxMap.brewery > -1 ? cols[idxMap.brewery] : "Unknown",
                            style: idxMap.style > -1 ? cols[idxMap.style] : "Unknown",
                            abvSum: abv, abvCount: abv > 0 ? 1 : 0,
                            aromaSum: aroma, appearanceSum: appearance, palateSum: palate, tasteSum: taste, overallSum: overall,
                            count: 1, colorIdx: Math.floor(Math.random() * colors.length)
                        };
                        aggregationMap.set(name, entry);
                    } else {
                        entry.count++; entry.aromaSum += aroma; entry.appearanceSum += appearance;
                        entry.palateSum += palate; entry.tasteSum += taste; entry.overallSum += overall;
                        if (abv > 0) { entry.abvSum += abv; entry.abvCount++; }
                    }
                    if (i % 5000 === 0) { self.postMessage({ type: 'progress', count: i, total: lines.length }); }
                }
                const aggregatedList = Array.from(aggregationMap.values()).map((item, index) => ({
                    id: index + 1000, name: item.name, brewery: item.brewery, style: item.style,
                    abv: item.abvCount > 0 ? parseFloat((item.abvSum / item.abvCount).toFixed(1)) : 0,
                    aroma: parseFloat((item.aromaSum / item.count).toFixed(2)),
                    appearance: parseFloat((item.appearanceSum / item.count).toFixed(2)),
                    palate: parseFloat((item.palateSum / item.count).toFixed(2)),
                    taste: parseFloat((item.tasteSum / item.count).toFixed(2)),
                    overall: parseFloat((item.overallSum / item.count).toFixed(2)),
                    review_count: item.count, imageColor: colors[item.colorIdx]
                }));
                self.postMessage({ type: 'done', data: aggregatedList, processedLines: processedCount });
            };
        `;

        // --- 初始模拟数据集 ---
        const INITIAL_DATA = [
            { id: 1, name: "Guinness Draught", brewery: "Guinness", style: "Irish Dry Stout", abv: 4.2, aroma: 4.0, appearance: 5.0, palate: 4.0, taste: 4.5, overall: 4.4, review_count: 1200, imageColor: "bg-gray-900" },
            { id: 2, name: "Sierra Nevada Pale Ale", brewery: "Sierra Nevada Brewing Co.", style: "American Pale Ale (APA)", abv: 5.6, aroma: 4.5, appearance: 4.0, palate: 4.0, taste: 4.5, overall: 4.5, review_count: 950, imageColor: "bg-amber-600" },
            { id: 3, name: "Budweiser", brewery: "Anheuser-Busch", style: "American Adjunct Lager", abv: 5.0, aroma: 2.0, appearance: 2.5, palate: 2.5, taste: 2.5, overall: 2.5, review_count: 2300, imageColor: "bg-yellow-400" },
            { id: 4, name: "Two Hearted Ale", brewery: "Bell's Brewery", style: "American IPA", abv: 7.0, aroma: 4.5, appearance: 4.0, palate: 4.5, taste: 4.5, overall: 4.6, review_count: 800, imageColor: "bg-orange-500" },
            { id: 5, name: "Blue Moon Belgian White", brewery: "Coors Brewing Company", style: "Witbier", abv: 5.4, aroma: 3.5, appearance: 3.5, palate: 3.5, taste: 3.5, overall: 3.5, review_count: 1500, imageColor: "bg-yellow-200" },
            { id: 6, name: "Pliny The Elder", brewery: "Russian River Brewing", style: "Imperial IPA", abv: 8.0, aroma: 5.0, appearance: 4.5, palate: 5.0, taste: 5.0, overall: 5.0, review_count: 600, imageColor: "bg-amber-500" },
        ];

        const UserRatingStars = ({ rating, onRate }) => {
            const [hover, setHover] = useState(0);
            return (
                <div className="star-rating">
                    {[...Array(5)].map((_, index) => {
                        const starValue = index + 1;
                        return (
                            <button
                                key={index} type="button" className="focus:outline-none transition-colors duration-150"
                                onClick={() => onRate(starValue)}
                                onMouseEnter={() => setHover(starValue)} onMouseLeave={() => setHover(0)}
                            >
                                <Star size={24} className={`${starValue <= (hover || rating) ? "text-yellow-400 fill-yellow-400" : "text-slate-300"} transition-colors`} />
                            </button>
                        );
                    })}
                </div>
            );
        };

        const ProgressBar = ({ label, value, max = 5, color = "bg-blue-500", icon: Icon }) => (
            <div className="mb-3">
                <div className="flex justify-between items-center mb-1">
                    <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                        {Icon && <Icon size={16} className="text-gray-500" />} {label}
                    </div>
                    <span className="text-sm font-bold text-gray-900">{typeof value === 'number' ? value.toFixed(2) : value}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2.5">
                    <div className={`h-2.5 rounded-full ${color} transition-all duration-500 ease-out`} style={{ width: `${Math.min((value / max) * 100, 100)}%` }}></div>
                </div>
            </div>
        );

        // --- Model Metrics Modal (包含训练功能) ---
        const ModelMetricsModal = ({ isOpen, onClose, beerData, onTrainStart, trainingState, trainedModel }) => {
            if (!isOpen) return null;
            const currentStats = useMemo(() => {
                if (!beerData || beerData.length === 0) return null;
                const totalBeers = beerData.length;
                // 新增：计算总评论数
                const totalRatings = beerData.reduce((acc, b) => acc + (b.review_count || 0), 0);
                const avgAbv = (beerData.reduce((acc, b) => acc + (b.abv || 0), 0) / totalBeers).toFixed(2);
                const avgScore = (beerData.reduce((acc, b) => acc + (b.overall || 0), 0) / totalBeers).toFixed(2);
                const highRatedCount = beerData.filter(b => b.overall >= 4).length;
                return { totalBeers, totalRatings, avgAbv, avgScore, highRatedCount };
            }, [beerData]);

            const importanceData = trainedModel?.featureImportance 
                ? [
                    { label: "Taste (味道)", value: Math.round(trainedModel.featureImportance.taste), color: "bg-orange-500" },
                    { label: "Aroma (香气)", value: Math.round(trainedModel.featureImportance.aroma), color: "bg-rose-500" },
                    { label: "Palate (口感)", value: Math.round(trainedModel.featureImportance.palate), color: "bg-amber-500" },
                    { label: "Appearance (外观)", value: Math.round(trainedModel.featureImportance.appearance), color: "bg-yellow-500" },
                    { label: "ABV (酒精度)", value: Math.round(trainedModel.featureImportance.abv), color: "bg-blue-500" },
                  ].sort((a,b) => b.value - a.value)
                : [
                    { label: "Review Taste (味道评分)", value: 95, color: "bg-orange-500" },
                    { label: "Review Aroma (香气评分)", value: 82, color: "bg-rose-500" },
                    { label: "Review Palate (口感评分)", value: 76, color: "bg-amber-500" },
                    { label: "Beer ABV (酒精度)", value: 45, color: "bg-blue-500" },
                    { label: "Review Appearance (外观评分)", value: 30, color: "bg-yellow-500" },
                ];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
                        {/* ... header ... */}
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-blue-100 text-blue-600 rounded-lg"><Activity size={24} /></div>
                                <div><h2 className="text-xl font-bold text-slate-800">数据与模型训练</h2><p className="text-xs text-slate-500">实时训练 & 性能评估</p></div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500"><X size={20} /></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><PieChart size={20} className="text-emerald-600" /> 当前导入数据概况</h3>
                                {/* 更新 grid 为 5 列以容纳总评论数，或者调整布局 */}
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                    <div className="bg-emerald-50 p-2.5 rounded-xl border border-emerald-100 text-center">
                                        <div className="text-xs text-emerald-600 font-medium mb-1">啤酒种类</div>
                                        <div className="text-xl font-black text-emerald-700">{currentStats ? currentStats.totalBeers : 0}</div>
                                    </div>
                                    <div className="bg-emerald-50 p-2.5 rounded-xl border border-emerald-100 text-center">
                                        <div className="text-xs text-emerald-600 font-medium mb-1">总评分样本</div>
                                        <div className="text-xl font-black text-emerald-700">{currentStats ? currentStats.totalRatings.toLocaleString() : 0}</div>
                                    </div>
                                    <div className="bg-emerald-50 p-2.5 rounded-xl border border-emerald-100 text-center">
                                        <div className="text-xs text-emerald-600 font-medium mb-1">平均酒精度</div>
                                        <div className="text-xl font-black text-emerald-700">{currentStats ? currentStats.avgAbv : 0}%</div>
                                    </div>
                                    <div className="bg-emerald-50 p-2.5 rounded-xl border border-emerald-100 text-center">
                                        <div className="text-xs text-emerald-600 font-medium mb-1">平均评分</div>
                                        <div className="text-xl font-black text-emerald-700">{currentStats ? currentStats.avgScore : 0}</div>
                                    </div>
                                    <div className="bg-emerald-50 p-2.5 rounded-xl border border-emerald-100 text-center">
                                        <div className="text-xs text-emerald-600 font-medium mb-1">高分(≥4)占比</div>
                                        <div className="text-xl font-black text-emerald-700">{currentStats ? Math.round((currentStats.highRatedCount / currentStats.totalBeers) * 100) : 0}%</div>
                                    </div>
                                </div>
                            </div>
                            <hr className="border-slate-200 mb-8" />
                            {/* ... rest of the modal ... */}
                            <div className="mb-8">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <Cpu size={20} className={trainingState.isTraining ? "text-amber-500 animate-pulse" : "text-blue-600"} /> 
                                        {trainedModel ? "浏览器自训练模型 (Linear Reg.)" : "推荐算法模型 (基于LightGBM离线)"}
                                    </h3>
                                    {!trainingState.isTraining && (
                                        <button 
                                            onClick={onTrainStart} 
                                            disabled={!beerData || beerData.length < 10}
                                            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all ${(!beerData || beerData.length < 10) ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white shadow-md hover:shadow-lg'}`}
                                        >
                                            <Play size={16} fill="currentColor" /> {trainedModel ? "重新训练" : "开始训练"}
                                        </button>
                                    )}
                                </div>

                                {trainingState.isTraining && (
                                    <div className="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
                                        <div className="flex justify-between text-xs font-bold text-amber-700 mb-2">
                                            <span>训练中 (Epoch {trainingState.epoch} / {trainingState.totalEpochs})</span>
                                            <span>RMSE: {trainingState.currentRmse.toFixed(4)}</span>
                                        </div>
                                        <div className="w-full bg-amber-200 rounded-full h-2.5 overflow-hidden">
                                            <div className="h-2.5 bg-amber-500 rounded-full transition-all duration-300" style={{ width: `${(trainingState.epoch / trainingState.totalEpochs) * 100}%` }}></div>
                                        </div>
                                    </div>
                                )}

                                {/* 核心指标展示区 (3列) */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div className={`p-4 rounded-xl border text-center transition-all ${trainedModel ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'}`}>
                                        <div className="text-sm font-medium mb-1 text-slate-500">RMSE (均方根误差)</div>
                                        <div className={`text-3xl font-black ${trainedModel ? 'text-green-600' : 'text-blue-600'}`}>
                                            {trainedModel ? trainedModel.rmse.toFixed(4) : "0.4235"}
                                        </div>
                                        <div className="text-[10px] text-slate-400 mt-1">
                                            {trainedModel ? "实时评估 (Local)" : "离线参考 (Kaggle)"}
                                        </div>
                                    </div>
                                    
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-center">
                                        <div className="text-sm font-medium mb-1 text-slate-500">训练耗时</div>
                                        <div className="text-3xl font-black text-slate-600">
                                            {trainedModel ? "< 1s" : "12.5s"}
                                        </div>
                                        <div className="text-[10px] text-slate-400 mt-1">
                                            {trainedModel ? "Browser (Web Worker)" : "Server (GPU)"}
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-center">
                                        <div className="text-sm font-medium mb-1 text-slate-500">AUC (分类场景)</div>
                                        <div className={`text-3xl font-black ${trainedModel ? 'text-purple-600' : 'text-purple-600'}`}>
                                            {trainedModel && trainedModel.metrics && trainedModel.metrics.auc !== undefined 
                                                ? trainedModel.metrics.auc.toFixed(2) 
                                                : "0.89"}
                                        </div>
                                        <div className="text-[10px] text-slate-400 mt-1">
                                            {trainedModel ? "实时评估 (Good >= 4)" : "离线参考 (Kaggle)"}
                                        </div>
                                    </div>
                                </div>

                                {trainedModel && (
                                    <div className="mb-6 p-3 bg-green-50 text-green-800 text-xs rounded-xl flex items-center gap-2">
                                        <CheckCircle size={16} /> 训练完成！已生成自定义权重 (Linear Regression)。
                                    </div>
                                )}

                                <div>
                                    <h4 className="text-sm font-bold text-slate-700 mb-3">特征重要性 (Feature Importance)</h4>
                                    <div className="space-y-3">
                                        {importanceData.map((feat, i) => (
                                            <div key={i}>
                                                <div className="flex justify-between text-xs mb-1">
                                                    <span className="font-medium text-slate-700">{feat.label}</span>
                                                    <span className="font-bold text-slate-900">{feat.value}</span>
                                                </div>
                                                <div className="w-full bg-slate-100 rounded-full h-1.5">
                                                    <div className={`h-1.5 rounded-full ${feat.color}`} style={{ width: `${feat.value}%` }}></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="p-4 bg-blue-50 text-blue-800 rounded-xl text-sm leading-relaxed border border-blue-100">
                                <h4 className="font-bold flex items-center gap-2 mb-2"><Info size={16}/> 原理说明</h4>
                                默认情况下，系统使用硬编码的 LightGBM 经验公式。点击“开始训练”后，浏览器将使用 Web Worker 启动一个<strong>多元线性回归 (Linear Regression)</strong> 任务，利用您上传的数据在本地实时学习评分规则。训练完成后，所有啤酒的 AI 预测分将基于这个新模型重新计算。
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, localApiEnabled, setLocalApiEnabled, localApiUrl, setLocalApiUrl }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Settings size={20} /> 系统设置</h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500"><X size={20} /></button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div>
                                <h3 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2"><Server size={16} className="text-blue-600"/> 本地模型 API 集成</h3>
                                <p className="text-xs text-slate-500 mb-4">允许网页调用您本地电脑上运行的 Python LightGBM 服务进行实时推理。</p>
                                <div className="flex items-center justify-between mb-4">
                                    <span className="text-sm text-slate-700 font-medium">启用本地 API 调用</span>
                                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="toggle" id="toggle" className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300" checked={localApiEnabled} onChange={(e) => setLocalApiEnabled(e.target.checked)} />
                                        <label htmlFor="toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${localApiEnabled ? 'bg-green-400' : 'bg-slate-300'}`}></label>
                                    </div>
                                </div>
                                {localApiEnabled && (
                                    <div className="fade-in"><label className="block text-xs font-bold text-slate-600 mb-1">API 地址 (URL)</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" value={localApiUrl} onChange={(e) => setLocalApiUrl(e.target.value)} placeholder="http://localhost:5000/predict" /><p className="text-[10px] text-amber-600 mt-2 flex items-start gap-1"><Info size={12} className="shrink-0 mt-0.5" /> 提示：请确保您的本地 Python 服务器已开启 CORS。</p></div>
                                )}
                            </div>
                        </div>
                        <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-end"><button onClick={onClose} className="px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-sm font-medium transition-colors">保存并关闭</button></div>
                    </div>
                </div>
            );
        };

        function BeerRecommendationApp() {
            const [beerData, setBeerData] = useState(INITIAL_DATA);
            const [searchTerm, setSearchTerm] = useState("");
            const [sortBy, setSortBy] = useState("default");
            const [selectedStyle, setSelectedStyle] = useState("all");
            const [selectedBrewery, setSelectedBrewery] = useState("all"); 
            const [selectedBeer, setSelectedBeer] = useState(null);
            const [userRatings, setUserRatings] = useState({});
            
            const [showMetrics, setShowMetrics] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            
            const [localApiEnabled, setLocalApiEnabled] = useState(false);
            const [localApiUrl, setLocalApiUrl] = useState("http://localhost:5000/predict");
            const [apiScore, setApiScore] = useState(null); 
            const [isApiLoading, setIsApiLoading] = useState(false);

            const [isImporting, setIsImporting] = useState(false);
            const [importStatus, setImportStatus] = useState("");
            const [progress, setProgress] = useState(0);
            
            const [trainingState, setTrainingState] = useState({ isTraining: false, epoch: 0, totalEpochs: 0, currentRmse: 0 });
            const [trainedModel, setTrainedModel] = useState(null); 

            const [visibleCount, setVisibleCount] = useState(50);
            const listRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const initData = async () => {
                    const cachedData = await loadFromDB('cachedBeers');
                    const cachedRatings = await loadFromDB('userRatings');
                    const cachedModel = await loadFromDB('trainedModel');
                    if (cachedData && cachedData.length > 0) { setBeerData(cachedData); setImportStatus(`已加载数据`); }
                    if (cachedRatings) setUserRatings(cachedRatings);
                    if (cachedModel) setTrainedModel(cachedModel);
                    setTimeout(() => setImportStatus(""), 3000);
                };
                initData();
            }, []);

            useEffect(() => {
                const fetchPrediction = async () => {
                    if (!selectedBeer || !localApiEnabled) { setApiScore(null); return; }
                    setIsApiLoading(true); setApiScore(null);
                    try {
                        const response = await fetch(localApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(selectedBeer) });
                        if (response.ok) { const data = await response.json(); setApiScore(data.score !== undefined ? Number(data.score).toFixed(1) : null); } else { setApiScore("Err"); }
                    } catch (error) { setApiScore("Err"); } finally { setIsApiLoading(false); }
                };
                fetchPrediction();
            }, [selectedBeer, localApiEnabled, localApiUrl]);

            const workerRef = useRef(null);
            useEffect(() => {
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                workerRef.current = new Worker(URL.createObjectURL(blob));
                workerRef.current.onmessage = async (e) => {
                    const { type, data, error, count, total, processedLines, epoch, epochs, rmse, weights, featureImportance, metrics } = e.data;
                    
                    if (error) { alert(`错误: ${error}`); setIsImporting(false); setTrainingState(prev => ({ ...prev, isTraining: false })); setImportStatus(""); return; }
                    
                    if (type === 'progress') { setProgress(Math.round((count / total) * 100)); setImportStatus(`后台计算中... ${Math.round((count / total) * 100)}%`); }
                    
                    if (type === 'done') {
                        let importedBeers = []; let importedRatings = {}; let importedModel = null;
                        if (Array.isArray(data)) { importedBeers = data; } 
                        else if (data.beerData) { importedBeers = data.beerData; importedRatings = data.userRatings || {}; importedModel = data.trainedModel || null; }
                        if (importedBeers.length > 0) { setBeerData(importedBeers); setImportStatus(`保存数据...`); await saveToDB('cachedBeers', importedBeers); }
                        if (Object.keys(importedRatings).length > 0) { setUserRatings(importedRatings); await saveToDB('userRatings', importedRatings); }
                        if (importedModel) { setTrainedModel(importedModel); await saveToDB('trainedModel', importedModel); }
                        setIsImporting(false); setProgress(100); setImportStatus(`完成！共 ${importedBeers.length} 款啤酒。`); setTimeout(() => setImportStatus(""), 5000);
                    }

                    if (type === 'train_progress') {
                        setTrainingState({ isTraining: true, epoch, totalEpochs: epochs, currentRmse: rmse });
                    }
                    if (type === 'train_done') {
                        // 使用 worker 返回的 metrics.auc
                        const newModel = { weights, rmse: metrics.rmse, auc: metrics.auc, featureImportance, metrics };
                        setTrainedModel(newModel);
                        setTrainingState({ isTraining: false, epoch: 0, totalEpochs: 0, currentRmse: 0 });
                        await saveToDB('trainedModel', newModel);
                    }
                };
                return () => workerRef.current?.terminate();
            }, []);

            const handleRateBeer = async (rating) => {
                if (!selectedBeer) return;
                const newRatings = { ...userRatings, [selectedBeer.id]: rating };
                setUserRatings(newRatings);
                await saveToDB('userRatings', newRatings);
            };

            const handleExportData = useCallback(() => {
                if (beerData === INITIAL_DATA || beerData.length === 0) { alert("无数据导出"); return; }
                const backupObject = { beerData: beerData, userRatings: userRatings, trainedModel: trainedModel, backupDate: new Date().toISOString() };
                const dataStr = JSON.stringify(backupObject);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const linkElement = document.createElement('a'); linkElement.setAttribute('href', dataUri); linkElement.setAttribute('download', 'beer_app_backup.json'); linkElement.click();
            }, [beerData, userRatings, trainedModel]);

            const handleReset = async () => {
                if(!confirm("确定要清空所有数据（包括您的评分和模型）吗？")) return;
                setBeerData(INITIAL_DATA); setUserRatings({}); setSelectedBeer(null); setTrainedModel(null);
                setImportStatus("清除缓存中..."); setSortBy("default"); setSelectedStyle("all"); setSelectedBrewery("all");
                await clearDB(); setImportStatus("");
            };

            const handleTrainStart = () => {
                if (!beerData || beerData.length < 10) return;
                setTrainingState({ isTraining: true, epoch: 0, totalEpochs: 2000, currentRmse: 0 });
                workerRef.current.postMessage({ type: 'train_model', data: beerData });
            };

            const uniqueStyles = useMemo(() => { const styles = new Set(beerData.map(b => b.style || "Unknown")); return Array.from(styles).sort(); }, [beerData]);
            const uniqueBreweries = useMemo(() => { const breweries = new Set(beerData.map(b => b.brewery || "Unknown")); return Array.from(breweries).sort(); }, [beerData]);

            const filteredBeers = useMemo(() => {
                let result = beerData;
                if (searchTerm) { const lowerTerm = searchTerm.toLowerCase(); result = result.filter(beer => (beer.name || "").toLowerCase().includes(lowerTerm) || (beer.style || "").toLowerCase().includes(lowerTerm) || (beer.brewery || "").toLowerCase().includes(lowerTerm)); }
                if (selectedStyle !== "all") result = result.filter(beer => beer.style === selectedStyle);
                if (selectedBrewery !== "all") result = result.filter(beer => beer.brewery === selectedBrewery);
                return [...result].sort((a, b) => {
                    if (sortBy === "rating") return (b.overall || 0) - (a.overall || 0);
                    if (sortBy === "count") return (b.review_count || 0) - (a.review_count || 0);
                    if (sortBy === "abv") return (b.abv || 0) - (a.abv || 0);
                    return 0; 
                });
            }, [searchTerm, beerData, sortBy, selectedStyle, selectedBrewery]);

            useEffect(() => { setVisibleCount(50); if (listRef.current) listRef.current.scrollTop = 0; }, [filteredBeers]);
            const handleScroll = (e) => { const { scrollTop, clientHeight, scrollHeight } = e.target; if (scrollHeight - scrollTop - clientHeight < 200) { setVisibleCount(prev => Math.min(prev + 50, filteredBeers.length)); } };
            const visibleBeers = useMemo(() => filteredBeers.slice(0, visibleCount), [filteredBeers, visibleCount]);

            const { recommendations, personalizedReason } = useMemo(() => {
                if (selectedBeer) {
                    const scoredBeers = beerData.filter(b => b.id !== selectedBeer.id).map(beer => {
                        let score = 0;
                        const currentStyle = selectedBeer.style || ""; const targetStyle = beer.style || "";
                        if (targetStyle === currentStyle) score += 50; else if (targetStyle.split(' ')[0] === currentStyle.split(' ')[0]) score += 20;
                        const abvDiff = Math.abs((beer.abv || 0) - (selectedBeer.abv || 0)); score += Math.max(0, (10 - abvDiff * 2));
                        const flavorDiff = Math.abs((beer.aroma || 0) - (selectedBeer.aroma || 0)) + Math.abs((beer.taste || 0) - (selectedBeer.taste || 0)) + Math.abs((beer.palate || 0) - (selectedBeer.palate || 0));
                        score += Math.max(0, (15 - flavorDiff * 3));
                        return { ...beer, similarityScore: score };
                    });
                    return { recommendations: scoredBeers.sort((a, b) => b.similarityScore - a.similarityScore).slice(0, 3), personalizedReason: null };
                }
                return { recommendations: [], personalizedReason: null };
            }, [selectedBeer, beerData, userRatings]);

            const personalizedList = useMemo(() => {
                const ratedIds = Object.keys(userRatings);
                if (ratedIds.length === 0) return [];
                let totalAbv = 0; let count = 0; const styleCounts = {};
                ratedIds.forEach(id => {
                    const beer = beerData.find(b => String(b.id) === id); const rating = userRatings[id];
                    if (beer && rating >= 3) { totalAbv += (beer.abv || 0); count++; const style = beer.style || "Unknown"; styleCounts[style] = (styleCounts[style] || 0) + (rating - 2); }
                });
                if (count === 0) return [];
                const avgAbv = totalAbv / count; const sortedStyles = Object.entries(styleCounts).sort((a, b) => b[1] - a[1]); const topStyle = sortedStyles[0] ? sortedStyles[0][0] : "";
                const candidates = beerData.filter(b => !userRatings[String(b.id)]);
                const scoredCandidates = candidates.map(beer => {
                    let score = 0; if (beer.style === topStyle) score += 40; else if (topStyle && beer.style.split(' ')[0] === topStyle.split(' ')[0]) score += 15;
                    const abvDiff = Math.abs((beer.abv || 0) - avgAbv); score += Math.max(0, 20 - abvDiff * 3); score += (beer.overall || 0) * 2;
                    return { ...beer, score };
                });
                return scoredCandidates.sort((a, b) => b.score - a.score).slice(0, 3);
            }, [userRatings, beerData]);

            const handleFileUpload = (event) => {
                const file = event.target.files[0]; if (!file) return; setIsImporting(true); setImportStatus("读取文件中..."); setProgress(0);
                const reader = new FileReader(); reader.onload = (e) => { const text = e.target.result; if (file.name.endsWith('.json')) { setImportStatus("加载缓存..."); workerRef.current.postMessage({ fileContent: text, type: 'json' }); } else { setImportStatus("分析 CSV..."); workerRef.current.postMessage({ fileContent: text, type: 'csv' }); } }; reader.readAsText(file); if (fileInputRef.current) fileInputRef.current.value = '';
            };
            const handleRandomPick = () => { if (filteredBeers.length === 0) { alert("无数据"); return; } const randomIndex = Math.floor(Math.random() * filteredBeers.length); setSelectedBeer(filteredBeers[randomIndex]); };
            
            const getPredictedScore = (beer) => {
                if (localApiEnabled) {
                    if (isApiLoading) return <Loader2 size={20} className="animate-spin text-amber-500" />;
                    if (apiScore === "Err") return <span className="text-xs text-red-400 font-normal">API离线</span>;
                    if (apiScore) return apiScore;
                    return "-";
                }
                
                if (trainedModel && trainedModel.weights) {
                    const w = trainedModel.weights;
                    const features = [
                        1,
                        (beer.aroma || 0) / 5,
                        (beer.appearance || 0) / 5,
                        (beer.palate || 0) / 5,
                        (beer.taste || 0) / 5,
                        (beer.abv || 0) / 20
                    ];
                    let score = 0;
                    for (let i = 0; i < w.length; i++) {
                        score += w[i] * features[i];
                    }
                    return Math.min(Math.max(score * 20, 0), 100).toFixed(1);
                }

                return ((beer.overall || 0) * 20).toFixed(1); 
            };

            const getModelStatusText = () => {
                if (localApiEnabled) return '本地 API 模式已开启';
                if (trainedModel) return '基于浏览器训练模型';
                return '基于LightGBM模型';
            }

            return (
                <div className="min-h-screen font-sans text-slate-900 flex flex-col h-screen overflow-hidden">
                    <header className="bg-gradient-to-r from-amber-600 to-orange-700 text-white p-4 shadow-lg shrink-0 z-20">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-white/20 rounded-full"><Beer size={28} /></div>
                                <div>
                                    <h1 className="text-xl font-bold tracking-tight">精酿啤酒推荐 <span className="text-xs bg-amber-800 px-2 py-0.5 rounded-full ml-2">绿色版</span></h1>
                                    <p className="text-amber-100 text-xs opacity-90">{getModelStatusText()}</p>
                                </div>
                            </div>
                            <div className="flex flex-col md:items-end gap-2 w-full md:w-auto">
                                <div className="flex gap-2 w-full md:w-auto items-center flex-wrap justify-end">
                                    <button onClick={() => setShowSettings(true)} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg transition-colors text-sm border ${localApiEnabled ? 'bg-emerald-500/20 border-emerald-400/50 text-emerald-100' : 'bg-white/10 border-white/20 hover:bg-white/20'}`}>
                                        <Settings size={14} /> <span className="hidden sm:inline">设置</span>
                                    </button>
                                    <button onClick={() => setShowMetrics(true)} className={`flex items-center gap-1 px-3 py-1.5 text-white rounded-lg transition-colors text-sm border ${trainedModel ? 'bg-indigo-500/40 border-indigo-300/50' : 'bg-blue-600/30 hover:bg-blue-600/50 border-white/20'}`}>
                                        <Activity size={14} /> <span className="hidden sm:inline">模型/训练</span>
                                    </button>
                                    <button onClick={handleRandomPick} className="flex items-center gap-1 px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg transition-colors text-sm"><Dices size={14} /> <span className="hidden sm:inline">手气不错</span></button>
                                    {beerData.length > INITIAL_DATA.length && <button onClick={handleExportData} className="flex items-center gap-1 px-3 py-1.5 bg-green-600/30 hover:bg-green-600/50 text-white rounded-lg transition-colors text-sm border border-white/20"><Download size={14} /> <span className="hidden sm:inline">导出备份</span></button>}
                                    <div className="relative">
                                        <input type="file" accept=".csv,.json" ref={fileInputRef} onChange={handleFileUpload} className="hidden" id="csv-upload" />
                                        <label htmlFor="csv-upload" className={`flex items-center gap-1 px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg cursor-pointer transition-colors text-sm ${isImporting ? 'opacity-50 pointer-events-none' : ''}`}>
                                            {isImporting ? <Loader2 className="animate-spin" size={14} /> : <Upload size={14} />} {isImporting ? `处理中 ${progress}%` : '导入 CSV/JSON'}
                                        </label>
                                    </div>
                                    <div className="relative w-full md:w-48">
                                        <Search size={14} className="absolute top-2.5 left-2.5 text-amber-200" />
                                        <input type="text" placeholder="搜索..." className="w-full pl-8 pr-3 py-1.5 bg-white/10 border border-white/20 rounded-lg text-white placeholder-amber-200/70 text-sm focus:outline-none focus:ring-1 focus:ring-white/50" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                    </div>
                                </div>
                                {importStatus && <div className="text-xs text-amber-100 font-medium flex items-center gap-1 animate-pulse"><Database size={12} /> {importStatus}</div>}
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 overflow-hidden">
                        <div className="lg:col-span-5 flex flex-col h-full overflow-hidden bg-white rounded-xl border border-slate-200 shadow-sm">
                            <div className="p-3 border-b border-slate-100 bg-slate-50 shrink-0 space-y-2">
                                <div className="flex justify-between items-center"><h2 className="text-sm font-bold text-slate-700 flex items-center gap-2"><FileText size={16} className="text-amber-600" />列表 ({filteredBeers.length})</h2><button onClick={handleReset} className="text-xs text-red-500 hover:text-red-700 underline">重置所有</button></div>
                                <div className="grid grid-cols-3 gap-2">
                                    <select value={selectedStyle} onChange={(e) => setSelectedStyle(e.target.value)} className="text-xs p-1.5 bg-white border border-slate-200 rounded-md outline-none truncate"><option value="all">所有风格</option>{uniqueStyles.map(s => <option key={s} value={s}>{s}</option>)}</select>
                                    <select value={selectedBrewery} onChange={(e) => setSelectedBrewery(e.target.value)} className="text-xs p-1.5 bg-white border border-slate-200 rounded-md outline-none truncate"><option value="all">所有酒厂</option>{uniqueBreweries.map(b => <option key={b} value={b}>{b}</option>)}</select>
                                    <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="text-xs p-1.5 bg-white border border-slate-200 rounded-md outline-none"><option value="default">默认</option><option value="rating">评分 (高)</option><option value="count">热度 (高)</option><option value="abv">酒精度 (高)</option></select>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar" ref={listRef} onScroll={handleScroll}>
                                {visibleBeers.map((beer) => (
                                    <div key={beer.id} onClick={() => setSelectedBeer(beer)} className={`group p-3 rounded-lg cursor-pointer transition-all border ${selectedBeer?.id === beer.id ? 'bg-amber-50 border-amber-500 shadow-sm ring-1 ring-amber-500' : 'bg-white border-slate-100 hover:border-amber-300 hover:shadow-sm'}`}>
                                        <div className="flex justify-between items-start">
                                            <div className="flex gap-3 items-center overflow-hidden">
                                                <div className={`w-10 h-10 rounded-full ${beer.imageColor} flex items-center justify-center text-white shadow-inner font-bold text-[10px] shrink-0`}>{beer.abv}%</div>
                                                <div className="min-w-0 flex-1">
                                                    <h3 className="font-bold text-sm truncate leading-tight text-slate-800">{beer.name}</h3>
                                                    <div className="flex items-center gap-1 text-xs text-slate-500 mt-0.5 truncate"><Factory size={10} /> <span>{beer.brewery}</span></div>
                                                </div>
                                            </div>
                                            <div className="flex flex-col items-end shrink-0 pl-2">
                                                <div className="flex items-center gap-1 text-amber-500 font-bold text-sm">
                                                    <Star size={12} fill="currentColor" /> {typeof beer.overall === 'number' ? beer.overall.toFixed(1) : beer.overall}
                                                </div>
                                                {userRatings[beer.id] && <div className="text-[10px] bg-blue-100 text-blue-700 px-1.5 rounded mt-1 font-medium">我评: {userRatings[beer.id]}★</div>}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {visibleBeers.length === 0 && <div className="text-center py-10 text-slate-400 text-sm">未找到相关啤酒</div>}
                            </div>
                        </div>

                        <div className="lg:col-span-7 h-full overflow-y-auto custom-scrollbar pr-1 flex flex-col gap-6">
                            {selectedBeer ? (
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden shrink-0">
                                    <div className="bg-slate-50 border-b border-slate-100 p-5 flex justify-between items-start">
                                        <div><h2 className="text-xl font-bold text-slate-800 leading-tight">{selectedBeer.name}</h2><div className="flex items-center gap-1 text-slate-500 mt-1 text-sm"><Factory size={14} /> <span className="font-medium">{selectedBeer.brewery}</span></div><div className="flex gap-2 mt-2"><span className="px-2 py-0.5 bg-slate-200 text-slate-600 text-xs rounded-full">{selectedBeer.style}</span></div></div>
                                        <div className="text-right shrink-0">
                                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">AI 预测分 {localApiEnabled && <span className="text-[9px] bg-blue-100 text-blue-700 px-1 rounded">API</span>}{trainedModel && !localApiEnabled && <span className="text-[9px] bg-indigo-100 text-indigo-700 px-1 rounded">自训练</span>}</div>
                                            <div className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-500 to-orange-600 flex justify-end items-center gap-2">{getPredictedScore(selectedBeer)}</div>
                                            <div className="mt-2 text-right"><div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">您的评分</div><UserRatingStars rating={userRatings[selectedBeer.id] || 0} onRate={handleRateBeer} /></div>
                                        </div>
                                    </div>
                                    <div className="p-5 grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div><h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><BarChart3 size={14} /> 风味分析</h3><ProgressBar label="Aroma" value={selectedBeer.aroma} color="bg-rose-400" icon={Wind} /><ProgressBar label="Taste" value={selectedBeer.taste} color="bg-orange-400" icon={Droplets} /><ProgressBar label="Palate" value={selectedBeer.palate} color="bg-amber-400" icon={Activity} /><ProgressBar label="Appearance" value={selectedBeer.appearance} color="bg-yellow-400" icon={Eye} /></div>
                                        <div className="flex flex-col gap-3">
                                            <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                                                <div className="flex justify-between items-center text-sm border-b border-slate-200 pb-2"><span className="text-slate-500">酒精度 (ABV)</span> <span className="font-bold text-slate-800">{selectedBeer.abv}%</span></div>
                                                <div className="flex justify-between items-center text-sm border-b border-slate-200 pb-2"><span className="text-slate-500">样本数</span> <span className="font-bold text-slate-800">{selectedBeer.review_count} 评</span></div>
                                                <div className="flex justify-between items-center text-sm"><span className="text-slate-500">大众评分</span><span className={`px-2 py-0.5 rounded text-xs font-bold ${selectedBeer.overall >= 4 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{selectedBeer.overall}</span></div>
                                            </div>
                                            <div className="p-3 bg-blue-50 text-blue-700 text-xs rounded-lg flex gap-2 items-start"><Info size={14} className="shrink-0 mt-0.5" /><span>
                                                {localApiEnabled 
                                                    ? "当前正在使用本地 Python API 进行实时推理。" 
                                                    : trainedModel 
                                                        ? "使用您在浏览器中训练的个性化模型进行预测。"
                                                        : "使用 Kaggle LightGBM 离线模型的经验公式。"}
                                            </span></div>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="h-48 flex flex-col items-center justify-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-300"><Beer size={32} className="text-slate-300 mb-2" /><p className="text-sm">请从左侧选择一款啤酒查看详情</p></div>
                            )}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {selectedBeer && (<div><h3 className="text-base font-bold text-slate-800 mb-3 flex items-center gap-2"><ThumbsUp size={18} className="text-amber-600" /> 相似推荐</h3><div className="space-y-3">{recommendations.map((rec) => (<div key={rec.id} onClick={() => setSelectedBeer(rec)} className="bg-white p-3 rounded-xl border border-slate-200 hover:shadow-md cursor-pointer flex gap-3 items-center"><div className={`w-8 h-8 rounded-full ${rec.imageColor} flex items-center justify-center text-white text-[9px] font-bold shrink-0`}>{rec.abv}%</div><div className="min-w-0 flex-1"><h4 className="font-bold text-slate-800 text-sm truncate">{rec.name}</h4><p className="text-xs text-slate-500 truncate">{rec.brewery}</p></div><span className="text-[10px] bg-green-50 text-green-700 px-2 py-0.5 rounded-full font-bold">{Math.round(rec.similarityScore)}% 似</span></div>))}</div></div>)}
                                <div><h3 className="text-base font-bold text-slate-800 mb-3 flex items-center gap-2"><Heart size={18} className="text-rose-500" /> 猜您喜欢 (个性化)</h3>{personalizedList.length > 0 ? (<div className="space-y-3">{personalizedList.map((rec) => (<div key={rec.id} onClick={() => setSelectedBeer(rec)} className="bg-gradient-to-r from-rose-50 to-white p-3 rounded-xl border border-rose-100 hover:shadow-md cursor-pointer flex gap-3 items-center"><div className={`w-8 h-8 rounded-full ${rec.imageColor} flex items-center justify-center text-white text-[9px] font-bold shrink-0`}>{rec.abv}%</div><div className="min-w-0 flex-1"><h4 className="font-bold text-slate-800 text-sm truncate">{rec.name}</h4><p className="text-xs text-slate-500 truncate">{rec.style}</p></div><div className="flex flex-col items-end"><Star size={12} className="text-rose-400 fill-rose-400" /><span className="text-[9px] text-rose-400">强推荐</span></div></div>))}</div>) : (<div className="bg-slate-50 border border-dashed border-slate-200 rounded-xl p-6 text-center text-slate-400"><User size={24} className="mx-auto mb-2 opacity-50" /><p className="text-xs">暂无个性化数据</p><p className="text-[10px] mt-1">请给几款您喜欢的啤酒打分 (3星以上)</p></div>)}</div>
                            </div>
                        </div>
                    </main>
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} localApiEnabled={localApiEnabled} setLocalApiEnabled={setLocalApiEnabled} localApiUrl={localApiUrl} setLocalApiUrl={setLocalApiUrl} />
                    <ModelMetricsModal isOpen={showMetrics} onClose={() => setShowMetrics(false)} beerData={beerData} onTrainStart={handleTrainStart} trainingState={trainingState} trainedModel={trainedModel} />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<BeerRecommendationApp />);
    </script>
</body>
</html>